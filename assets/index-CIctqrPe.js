var b=Object.defineProperty;var C=(a,e,t)=>e in a?b(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var o=(a,e,t)=>(C(a,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();document.querySelector(".startButton");document.querySelector(".chat-input-form");const f=document.getElementById("user_information_profile_container").children[1].innerText;document.querySelector(".message-list");class y{constructor(e,t){o(this,"baseUri");o(this,"modelName");this.modelName=t,this.baseUri=e}async getAnswer(e,t,i){const s={message:t,member_name:e,vf:"vf_req",scope:i,model_name:this.modelName};console.log("send to API...",s);{const r=`drochila228 /reply ${JSON.stringify(s)}`,n=()=>document.getElementById("HOLDER_DIV").innerText,l=n();return console.log(r),await new Promise(h=>{let c;c=setInterval(()=>{l!=n()&&(clearInterval(c),h(JSON.parse(n())))},200)})}}}const x=new y("",f);class m{constructor(e="",t="global",i,s){o(this,"member");o(this,"chat");o(this,"htmlContainer");o(this,"previewContainer");o(this,"queue",0);o(this,"observer",new MutationObserver(e=>{for(let t of e)t.type==="childList"&&t.addedNodes.length>0&&this.handler(this.processor(t.addedNodes))}));o(this,"scope");o(this,"input");console.log("Create chat instance. Member:",e," scope:",t),this.member=e,this.scope=t,this.htmlContainer=i,this.previewContainer=s}initChat(){const e=this.scope=="global"?0:1;this.chat=this.htmlContainer.children[e].children[1],this.input=this.htmlContainer.children[e*2+1].children[0].children[0],this.sendBtn=this.htmlContainer.children[e*2+1].children[1].children[e+1].children[0],console.log("Init chat instance. Member:",this.member," scope:",this.scope),this.closeObserve(),this.startObserve()}startObserve(e={}){e.childList=!0,this.observer.observe(this.chat,{childList:!0})}closeObserve(){this.observer&&this.observer.disconnect()}parseUserMessage(e){const t=e.children[0].children,s=t[0].children[1].innerText,n=t[1].children[0].innerText,l="user";return console.log(this.member==s),{member:s,message:n,type:l,scope:this.scope}}parseNotification(e){return{message:e.innerText,type:"notice",scope:this.scope}}processor(e){const t=[];return e.forEach(i=>{if(i.children[0].classList.contains("roomNotice")||i.classList.contains("roomNotice"))t.push(this.parseNotification(i));else{const s=this.parseUserMessage(i);s.member!=f&&s.message.substring(0,1)!="/"&&t.push(s)}}),t}createConfirm(e,t,i,s,r,n){const l=document.createElement("div");l.style="padding: 10px; border: 1px black solid; display: flex; flex-direction: column; margin-bottom: 20px; font-size: 14px; line-height: 2;";const h=document.createElement("p");h.style="color: white; margin-bottom: 10px; font-size: ",h.innerHTML=e;const c=document.createElement("div");c.style="display: flex; flex-direction: row; gap: 50px";const d=document.createElement("button");d.innerText="Ok",d.addEventListener("click",()=>{i(t),l.remove()});const p=document.createElement("button");p.innerText="Edit",p.addEventListener("click",()=>{r(t),l.remove()});const v=document.createElement("button");p.innerText="Regenerate",p.addEventListener("click",()=>{n(t),l.remove()});const u=document.createElement("button");u.innerText="Cancel",u.addEventListener("click",()=>{s(t),l.remove()}),c.appendChild(d),c.appendChild(p),c.appendChild(v),c.appendChild(u),l.appendChild(h),l.appendChild(c),l.appendChild(document.createElement("hr")),this.previewContainer.appendChild(l)}async sendToChat(e){this.queue++;let t=await x.getAnswer(e.member,e.message,e.scope).then(n=>n.reply).catch(n=>alert("2"+n));const i=t.split("v1: ");i[1]&&(t=i[1]);const s=t.substring(0,1).toLowerCase();t=`${e.member}, ${s}${t.substring(1,t.length)}`.replace("v1:"," ").replace("v1","me").replace("YourName",e.member),t=t.replace(/\{\{.*\}\}/,"");const r=t.split("+");r[1]&&(t=r[0]),this.createConfirm(`#${e.scope} <br> <span style="font-weight: bold;">${e.member}:</span> <span style="font-style: italic">"${e.message}"</span>, <br> <span style="font-weight: bold;">AI:</span> <span style="font-style: italic;">"${t}"</span>`,{reply:t,answerTo:e},n=>{this.input.innerText=n.reply,this.sendBtn.click(),this.queue--},n=>{},n=>{this.input.innerText=n.reply,this.queue--},n=>{this.sendToChat(e),this.queue--})}handler(e){e.length&&e.filter(t=>t.type=="user").forEach(t=>this.sendToChat(t,t.message))}}class E{constructor(){o(this,"chat");o(this,"privateChats",{});o(this,"listeners",[]);o(this,"isRunning",!1);o(this,"stopAllBtn");o(this,"previewContainer")}createRefreshChatButton(){const e=document.querySelector(".roomTitle");e.style.height="50px";const t=document.createElement("button");t.addEventListener("click",()=>{this.updateChatListeners()}),t.innerText="Refresh available chat",e.prepend(t),t.style.marginLeft="20px"}createStopAllButton(){const e=document.querySelector(".roomTitle");e.style.height="50px",this.stopAllBtn=document.createElement("button"),this.stopAllBtn.addEventListener("click",()=>{this.stopAll()}),this.stopAllBtn.innerText="Stop AI",e.prepend(this.stopAllBtn)}createPreviewModal(){this.previewContainer=document.createElement("div"),this.previewContainer.style="background: black; min-width: 500px; min-height: 200px; max-height: 90px; padding: 30px; color: white; position: absolute; z-index: 99999; top: 0; right: 20px; overflow: scroll;",document.querySelector("#base").appendChild(this.previewContainer)}createApplicationHolder(){const e=document.createElement("div");e.id="HOLDER_DIV",document.querySelector("#base").appendChild(e)}initialize(){this.isRunning=!0,this.createRefreshChatButton(),this.createStopAllButton(),this.createPreviewModal(),this.createApplicationHolder()}startGlobalChat(e){this.chat&&this.chat.closeObserve(),this.chat=new m("","global",e,this.previewContainer),this.chat.initChat()}startPrivateChat(e,t){console.log(t),this.privateChats[e]&&this.privateChats[e].closeObserve(),this.privateChats[e]=new m(e,"dm",t,this.previewContainer),this.privateChats[e].initChat(),console.log(this.privateChats)}getMember(e){let t="global";if(e.parentElement.hasAttribute("ts")&&e.parentElement.attributes.getNamedItem("ts").value=="fe"){const i=e.children[1].children[0].children[0].innerText.split(" ");t=i[i.length-1]}return t}chatClicked(e){if(!this.isRunning)return;const t=e.parentElement;let i=this.getMember(t);this.listeners.includes(i)||(t.parentElement.hasAttribute("ts")&&t.parentElement.attributes.getNamedItem("ts").value=="fe"?(console.log("Start private chat"),this.startPrivateChat(i,t)):(console.log("Start global chat"),this.startGlobalChat(t)),this.listeners.push(i),alert(`AI Companion for ${i} session started`))}updateChatListeners(){document.querySelectorAll(".msg-list-wrapper-split").forEach(e=>{e.addEventListener("click",()=>{this.chatClicked(e)})})}stopAll(){this.isRunning?(console.log("Stopping..."),this.isRunning=!1,this.chat&&this.chat.closeObserve(),Object.values(this.privateChats).map(e=>e.closeObserve()),this.stopAllBtn.innerText="Start AI",this.previewContainer.style="display: none;"):(console.log("Running..."),this.isRunning=!0,this.chat&&this.chat.startObserve(),Object.values(this.privateChats).map(e=>e.startObserve()),this.stopAllBtn.innerText="Stop AI",this.previewContainer.style="background: black; min-width: 500px; min-height: 200px; max-height: 90px; padding: 30px; color: white; position: absolute; z-index: 99999; top: 0; left: 20%; overflow: scroll;")}}const g=new E;document.querySelector("div.chat_broadcast")?(document.querySelector(".roomTitle").addEventListener("click",()=>{g.updateChatListeners()}),g.initialize()):console.log("Close plz");
